<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carrega Excel i Filtra Registres</title>
</head>
<body>
    <p id="current-date"></p>
    <input type="file" id="file-input" accept=".xlsx">
    <p id="filtered-data"></p>
    <button id="download-excel" style="display: none;">Descarregar Excel</button>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js" integrity="sha512-r22gChDnGvBylk90+2e/ycr3RVrDi8DIOkIGNhJlKfuyQM4tIRAI062MaV8sfjQKYVGjOBaZBOA87z+IhZE9DA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script>
        // Funció per obtenir la data actual en format Excel (número de sèrie)
        function getCurrentDateInExcelFormat() {
            const today = new Date();
            const excelDate = 25569 + (today.getTime() / (24 * 60 * 60 * 1000)); // Conversió a format Excel
            return excelDate;
        }

        // Funció per convertir una data Excel a "DD/MM/AAAA"
        function excelDateToDDMMYYYY(excelDate) {
            const milliseconds = (excelDate - 25569) * (24 * 60 * 60 * 1000);
            const date = new Date(milliseconds);
            return date.toLocaleDateString();
        }

        // Mostra la data actual en un element HTML
        document.getElementById('current-date').textContent = `Data d'avui en format Excel: ${excelDateToDDMMYYYY(getCurrentDateInExcelFormat())}`;

        document.getElementById('file-input').addEventListener('change', handleFile);

        function handleFile(event) {
            const file = event.target.files[0];

            if (file) {
                const reader = new FileReader();

                reader.onload = function(e) {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });

                    // Escull la primera fulla del fitxer Excel
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];

                    // Utilitza la funció utils.sheet_to_json per llegir les dades com a matriu d'objectes
                    const dataFromSheet = XLSX.utils.sheet_to_json(worksheet, { header: 1, range: 13 });

                    // Obtenir la data actual en format Excel
                    const currentDateInExcelFormat = getCurrentDateInExcelFormat();

                    // Filtra les dades i crea un objecte JSON amb les columnes 0, 1, 29, 31, 3, 24, 23 i data_actual
                    const filteredData = dataFromSheet.filter(row => {
                        return (
                            row[3] === "Marca" &&
                            row[24] === "Oficina Espanyola de Patents i Marques (OEPM)" &&
                            row[31] < currentDateInExcelFormat &&
                            row[7] === "Alta" &&
                            row[0] < 30
                        );
                    }).map(row => {
                        return {
                            column0: row[0],    // Columna 0
                            column1: row[1],    // Columna 1
                            column29: row[29],  // Columna 29
                            column31: row[31],  // Columna 31
                            column3: row[3],
                            column24: row[24],
                            column23: row[23],
                            data_actual: currentDateInExcelFormat
                        };
                    });

                    // Mostra l'objecte JSON a la consola
                    console.log('Dades filtrades:', filteredData);

                    // EXECUTA CONSULTA WEB:

                    // Inicialitza un objecte JSON buit per emmagatzemar els resultats
                    const results = {
                        marquesOEPM: []
                    };

                    // Defineix una funció asincrònica per fer el web scraping i emmagatzemar els resultats
                    async function scrapeAndStoreResults(item) {
                        const result = await webScraping(item.column23);
                        return {
                            codi_OEPM: item.column23,
                            estat: result.pText,
                            anotacio: result.lastTdText,
			    seccio: item.column0,
			    denominacio: item.column1,
			    data_fi: excelDateToDDMMYYYY(item.column31)
                        };
                    }

                    // Utilitza Promise.all per executar les crides asíncretes i esperar els resultats
                    const scrapingPromises = filteredData.map(item => scrapeAndStoreResults(item));

                    Promise.all(scrapingPromises)
                        .then(scrapingResults => {
                            results.marquesOEPM = scrapingResults;

                            // Converteix l'objecte JSON a una cadena JSON
                            const resultsJSON = JSON.stringify(results);

// Obtenir l'array "marquesOEPM" del JSON original
// Dades JSON de mostra
const arrayMarquesOEPM = results.marquesOEPM;

// Crear un objecte de tipus XLSX
const ws = XLSX.utils.json_to_sheet(arrayMarquesOEPM);
const wb = XLSX.utils.book_new();
XLSX.utils.book_append_sheet(wb, ws, "Dades");

// Generar un arxiu XLSX en format de full de càlcul
XLSX.writeFile(wb, 'dades.xlsx');


                            
                        })
                        .catch(error => {
                            console.error('ERROR:', error);
                        });
                };

                reader.readAsArrayBuffer(file);
            }
        }

        async function webScraping(codi) {
            const tempsAleatori = await dormir();

            const dataEnFormatAAAAMMDD = "2023/11/02";
            const url = "https://cors-anywhere.herokuapp.com/https://consultas2.oepm.es/ceo/jsp/busqueda/consultaExterna.xhtml?numExp=M" + codi;
            const response = await fetch(url);
            const html = await response.text();
            const doc = new DOMParser().parseFromString(html, 'text/html');

            // Cerca l'element <h4> amb el text "Estado:" dins del div amb la classe "div2col"
            const div2colElements = doc.querySelectorAll('.div2col');
            let pText = '';

            for (const div2colElement of div2colElements) {
                // CERCA L'ELEMENT "ESTADO"
                const h4Element = div2colElement.querySelector('h4.noWidth');

                // Comprova si l'element <h4> conté el text "Estado:"
                if (h4Element && h4Element.textContent.trim() === "Estado:") {
                    const pElement = div2colElement.querySelector('p.noWidth');

                    // Obteniu el contingut de l'element <p>
                    pText = pElement.textContent.trim();
                    break; // Sortim del bucle si trobem l'element desitjat
                }
            }

            console.log(`Codi: ${codi}, Resultat: ${pText}`);

            // Seleccioneu la taula amb l'atribut role="grid"
            const tableElement = doc.querySelector('table[role="grid"]');

            if (tableElement) {
                // Seleccioneu l'últim element <td role="gridcell> dins de la taula
                const tdElements = tableElement.querySelectorAll('td[role="gridcell"]');
                const lastTdElement = tdElements[tdElements.length - 1];

                // Obteniu el contingut de l'últim element <td>
                const lastTdText = lastTdElement.textContent.trim();

                console.log(lastTdText);

                return { pText, lastTdText };
            }
        }

        function dormir() {
            const tempsEspera = Math.floor(Math.random() * 9000) + 1000;
            return new Promise(resolve => setTimeout(resolve, tempsEspera));
        }
    </script>
</body>
</html>
